---
layout:     post
title:      Orange'S：一个操作系统的实现
subtitle:   克勤克俭内存
date:       2019-10-31
header-img: img/post-first-blog-web.jpg
catalog: true
tags:
    - x86
    - 操作系统
    - 保护模式
    - 克勤克俭

---

### 克勤克俭用内存

前面程序中，用4MB 得空间来存放页表，并用它映射了4GB的内存空间，而我们的物理内存不见得这么大，如果仅仅是对等映射的话，16MB 的内存主要4个页表就够了(一个页表项是4字节 ，有二级页表有1024个表项，每一个表项是对应一个物理页4k的，所以一个页表映射4MB，4个页表映射16MB，注意这个指的是映射空间，一个页表本身占用的4字节乘以 1024 = 4096字节)！所以我们有必要知道内存有多大！方便内存管理！

程序如何知道机器有多少内存！有很多方法，但是书上作者就提供了通用型强的方法，利用中断15h。

- eax int 15h 可完成许多任务，主要由ax的值决定，我们获取的内存信息，需要将ax赋值位0E820.
- ebs 放置着“后续值 (continuation value)”,第一次调用时ebx必须为0.
- es:di 指向一个地址范围描述符结构ARDS (Address Range Descriptor Structure),BIOS将会填充此结构。
- ecs es:di 所指向的地址范围描述符的大小，以字节为单位。无论es：di 所指向的结构如何设置， BIOS 最多将会填充ecx个字节。不过，通常情况下无论ecx为多大，BIOS 只填充20字节，有些BIOS 忽略ecx的值，总是填充20个字节！
- edx 0534D4150h ('SMAP') ----- BIOS将会使用此标志，对调用者将要请求的系统映像信息进行校验，这些信息会被BIOS 放置到es：di所指向的结构中。

中断调用之后，结果存放于下列寄存器之中。

- CF CD=0 表示没有错误，否则存在错误。
- eax 0534D4150h('SMAP')。
- es:di 返回的地址范围描述符结构指针，和输入值相同。
- ecs BIOS填充在地址范围描述符中的字节数量，被BIOS所返回的最小值是20字节！
- ebx 这里放置着为等到下一个地址描述符所需要的后续值，这个值得世纪形式依赖于具体的BIOS的实现，调用者不必关心它的具体形式，只需在下次迭代时将其原封不动的放置到ebx中，就可以通过它获取下一个地址范围描述符。如果它的值为0，并且CF 没有进位，表示它是最后一个地址范围描述符。

上面提到的地址范围描述符结构（Address Range Descriptor Structure），如表所示

![](https://raw.githubusercontent.com/dbb4560/StorePicturebed/master/wirtePicture/20191106235801.png)

其中Type的取值和其意义如表：

![](https://raw.githubusercontent.com/dbb4560/StorePicturebed/master/wirtePicture/20191106235811.png)




